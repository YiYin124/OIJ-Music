@using System.Text.RegularExpressions;

@{
    if (IsPost)
    {
        var name = Request.Form["name"];
        var mail = Request.Form["mail"];
        var password = Request.Form["password"];
        if (Regex.IsMatch(name, @"^[\w\u3100-\u312F\u4E00-\u9FCC\uF900-\uFAFF\u2F00-\u2FDF\u1100-\u11FF\uAC00-\uD7AF\u3040-\u309F\u30A0-\u30FF\u3190-\u319F\uA4D0-\uA4FF\u16F00-\u16F9F]+$") &
            Regex.IsMatch(mail, @"^(\w+\-|\w+\.)*\w+@(\w+\-|\w+\.)*\w+\.\w+$") & 
            Regex.IsMatch(password, @"^\w+$"))
        {
            using (var db = Database.Open("OIJ-Music"))
            {
                if (db.QuerySingle("SELECT Name FROM Account WHERE Name = @0", name) == null &
                    db.QuerySingle("SELECT Email FROM Account WHERE Email = @0", mail) == null)
                {
                    db.Execute("INSERT INTO Account (Name, Email, Password) VALUES(@0, @1, @2)", name, mail, password);
                    Response.Write("{ \"IsOk\": true }");
                }
                else
                {
                    Response.Write("{ \"IsOk\": false, \"reason\": \"这可能是一个 Hacker 行为!\" }");
                }
            }
        }
        else
        {
            Response.Write("{ \"IsOk\": false, \"reason\": \"这可能是一个 Hacker 行为!\" }");
        }
    }
    else if (!Request.QueryString["name"].IsEmpty())
    {
        using (var db = Database.Open("OIJ-Music"))
        {
            if (db.QuerySingle("SELECT Name FROM Account WHERE Name = @0", Request.QueryString["name"]) == null)
            {
                Response.Write("{ \"IsOk\": true }");
            }
            else
            {
                Response.Write("{ \"IsOk\": false }");
            }
        }
    }
    else if (!Request.QueryString["mail"].IsEmpty())
    {
        using (var db = Database.Open("OIJ-Music"))
        {
            if (db.QuerySingle("SELECT Email FROM Account WHERE Email = @0", Request.QueryString["mail"]) == null)
            {
                Response.Write("{ \"IsOk\": true }");
            }
            else
            {
                Response.Write("{ \"IsOk\": false }");
            }
        }
    }
}